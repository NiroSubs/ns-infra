AWSTemplateFormatVersion: '2010-09-09'
Description: 'Route53 DNS configuration for vf-dev environment'

Parameters:
  HostedZoneId:
    Type: String
    Default: Z015790023056BKZ15UTB
    Description: Route53 Hosted Zone ID for visualforge.ai

Resources:
  # Development subdomain records
  DevMainRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: dev.visualforge.ai
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontInfo.Domain
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront Hosted Zone ID
        EvaluateTargetHealth: false

  AppDevRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: app-dev.visualforge.ai
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontInfo.Domain
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false

  ApiDevRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: api-dev.visualforge.ai
      Type: CNAME
      TTL: 300
      ResourceRecords:
        - !GetAtt ApiGatewayInfo.Endpoint

  AuthDevRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: auth-dev.visualforge.ai
      Type: CNAME
      TTL: 300
      ResourceRecords:
        - !Sub 'visualforge-auth-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com'

  MediaDevRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: media-dev.visualforge.ai
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontInfo.Domain
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false

# Custom resources to get CloudFront and API Gateway info
  CloudFrontInfo:
    Type: Custom::CloudFrontInfo
    Properties:
      ServiceToken: !GetAtt GetCloudFrontFunction.Arn
      StackName: ns-cloudfront

  ApiGatewayInfo:
    Type: Custom::ApiGatewayInfo
    Properties:
      ServiceToken: !GetAtt GetApiGatewayFunction.Arn
      ApiName: ns-api

  GetCloudFrontFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: GetCloudFrontInfo
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  cf_client = boto3.client('cloudformation')
                  stack_name = event['ResourceProperties']['StackName']
                  
                  response = cf_client.describe_stacks(StackName=stack_name)
                  outputs = response['Stacks'][0].get('Outputs', [])
                  
                  domain = None
                  for output in outputs:
                      if output['OutputKey'] == 'CloudFrontDomainName':
                          domain = output['OutputValue']
                          break
                  
                  if not domain:
                      # Fallback to known CloudFront distribution
                      domain = 'd2nsuzyev8ci1a.cloudfront.net'
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Domain': domain})
              except Exception as e:
                  # Use fallback domain on error
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Domain': 'd2nsuzyev8ci1a.cloudfront.net'})

  GetApiGatewayFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: GetApiGatewayInfo
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  api_client = boto3.client('apigatewayv2')
                  api_name = event['ResourceProperties']['ApiName']
                  
                  response = api_client.get_apis()
                  endpoint = None
                  
                  for api in response.get('Items', []):
                      if api['Name'] == api_name:
                          endpoint = api['ApiEndpoint'].replace('https://', '')
                          break
                  
                  if not endpoint:
                      # Fallback to known API Gateway
                      endpoint = 'ky4hqo8j67.execute-api.us-east-1.amazonaws.com'
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Endpoint': endpoint})
              except Exception as e:
                  # Use fallback endpoint on error
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Endpoint': 'ky4hqo8j67.execute-api.us-east-1.amazonaws.com'})

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DescribeResources
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - apigatewayv2:GetApis
                Resource: '*'

Outputs:
  DevDomain:
    Description: Development domain
    Value: https://dev.visualforge.ai
  
  AppDevDomain:
    Description: App development domain
    Value: https://app-dev.visualforge.ai
  
  ApiDevDomain:
    Description: API development domain
    Value: https://api-dev.visualforge.ai
  
  AuthDevDomain:
    Description: Auth development domain
    Value: https://auth-dev.visualforge.ai
  
  MediaDevDomain:
    Description: Media development domain
    Value: https://media-dev.visualforge.ai